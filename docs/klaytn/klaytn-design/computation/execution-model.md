# Execution Model

This chapter describes the execution model, the data structures, and the life cycle of Klaytn smart contracts.

## Execution Model

Transactions can be generated by platform APIs as described in [Platform API Specification](). These transactions are sent to _Consensus Nodes \(CNs\)_ to be stored in a block. The CNs check whether each received transaction is valid. Valid transactions are stored in the transaction pool; otherwise, they are discarded. A CN selects the executable transactions in the current block in its transaction pool and executes them one by one.

To execute a transaction, the sender must pay some amount of KLAY as a transaction fee. This transaction fee in KLAY is calculated based on gas and a multiplier, _i.e._, unit price. A gas is the fundamental unit of computation. Every operation executed on a Klaytn node consumes a predefined amount of gas. The exact amount of KLAY required for the transaction is calculated by the formula illustrated in [Transaction Fee](). The transaction can fail if the sender submits a transaction accompanied by insufficient gas. A transaction can also fail if the sender's account has an insufficient balance.

When a transaction is executed successfully, it is included in the current block. A CN gathers transactions until it reaches block gas limit or block time limit. Then, the CN makes a block with the transactions. This step requires filling several fields in the block. For example, it must calculate the hash values of transactions, receipts, state, etc. After all required fields have been completed, the CN generates a block hash.

When block generation is complete, the block is propagated to all the other CNs. The other CNs all verify the propagated block and reach consensus on the verification results by using the BFT consensus algorithm. When the verification process completes successfully by the majority of CNs, the block is stored in the blockchain. Because the BFT consensus algorithm satisfies the immediate finality property, the block is final and will never be removed. After a block is finalized, the execution of all the transactions in that block are irreversibly guaranteed, and their execution results can be returned to the sender if requested.

### Restrictions on Transaction Execution

Klaytn's Baobab and Cypress networks currently have the following restrictions on the transaction execution:

* A transaction must set its gas price to Klaytn's [unit price](), _i.e._, 25 Gpeb.
* A transaction which has bigger execution cost than a computation cost limit is discarded. Please refer to [computation cost]()

## Data Structures

### Account

An account in Klaytn blockchain platform is a data structure containing information about a person's balance or a smart contract. Klaytn redesigns its account model to provide better DX and UX. Detailed information about the account model can be found [here]().

### Transaction

A transaction in a blockchain platform is a message sent between nodes that changes the state of the blockchain. Klaytn also redesigns its transaction model. Transactions are separated into various types according to their own purposes to find chances of performance optimization and to support the redesigned account model. Detailed information about the transaction model can be found [here]().

### State

Klaytn's **state** is a collection of account states. This state must be the same across Klaytn nodes if they have processed the same blocks in the same order. The state is changed when a transaction is executed on a Klaytn node.

The table below shows the account data that are stored in the state.

| Component | Description |
| :--- | :--- |
| Nonce | An integer value indicating the number of transactions executed by this account. To submit a transaction with the account, the `nonce` of the transaction should be one greater than the account's nonce. |
| Balance | An integer value showing the amount of KLAY that this account currently has. |
| StorageRoot | A 256-bit hash of the root of the Merkle Patricia Trie that contains the values of all the storage variables in the account. |
| CodeHash | The hash of the account's bytecode.  This value is immutable, which means it is set only when the smart contract is created.  If the account is an EOA or an EA, this value is set to the hash of null. |

### Block

A block is a crucial element of the Klaytn blockchain because the blockchain literally consists of a chain of blocks. The table below shows the components in a block.

| Component | Description |
| :--- | :--- |
| ParentHash | The hash of the block's parent block. |
| Rewardbase | The account address receiving the block reward. |
| Root | The hash of the root of the Merkle Patricia Trie of the blockchain state. |
| TxHash | The hash of the transactions included in the block. |
| ReceiptHash | The hash of the receipts of transactions included in the block. |
| Bloom | The Bloom filter value of the receipts. |
| Number | An integer value equal to the number of ancestor blocks. |
| GasUsed | The number of gas used to process transactions in the block. |
| Time | An integer value equal to the Unix timestamp when the block was generated. |
| Extra | RLP encoded string which includes validators list, proposer's seal and committed validators' seals |
| Transactions | The transactions included in the block. |

## Smart Contract

A _smart contract_ consists of a collection of code \(functions\) and data \(state\) that resides at a specific address on the Klaytn blockchain. Contract accounts are able to pass messages between each other as well as perform practically Turing complete computation. Contracts exist on the blockchain in Klaytn-specific binary formats. Currently, Klaytn supports one binary format --Ethereum Virtual Machine \(EVM\) bytecode; however, other formats will be supported in the future.

### Creating Smart Contracts

A smart contract can be created in the Klaytn blockchain by sending a transaction to an empty address with the binary as data. The binary can be in various formats; however, Klaytn currently supports one binary format, EVM bytecode. It is worth pointing out that this transaction requires a payment for execution. The account balance on the sender's account will be reduced according to the transaction fee model after the transaction has been stored in a block. After some time, the transaction should appear in a block, which confirms that the state it entails reached a consensus. At this point, the smart contract now exists in the Klaytn blockchain.

### Executing Smart Contracts

A function of a smart contract can be called and executed either by sending a transaction to the smart contract or by calling the function locally in the node. When a function is called by sending a transaction, the function is executed by processing a transaction. This entails a cost in KLAY for sending the transaction, and the call will be recorded forever on the blockchain. The return value of calls made in this manner is the hash of the transaction. When the function is invoked locally, it is executed locally in the Klaytn Virtual Machine \(KLVM\), and the call returns the return value of the function. Calls made in this manner are not recorded on the blockchain; thus, they cannot modify the internal state of the contract. This type of call is referred to as a constant function call. Calls made in this manner do not cost any KLAY. Constant function calls should be used when only the return value is of interest, while a transaction should be used when side effects on the contract state are of interest.

### Disabling Smart Contracts

Because smart contracts exist in the Klaytn blockchain, they cannot be deleted; they can only be disabled. For now, Klaytn has adopted the same process for disabling a Klaytn smart contract as is used for disabling smart contracts in Ethereum. For example, the Klaytn smart contract for KLVM can be disabled by using the [`selfdestruct(address recipient)`](https://solidity.readthedocs.io/en/v0.4.24/introduction-to-smart-contracts.html#self-destruct) call in Solidity \(or the KLVM opcode `SELFDESTRUCT`\). The Klaytn team will also provide ways to disable smart contracts for other execution environments.

### Upgrading Smart Contracts

Klaytn will provide ways to upgrade a deployed smart contract to address the inconvenient user experience with existing blockchains. For example, deployed services on blockchains are difficult to upgrade. Klaytn will provide frameworks and smart contract libraries to enable service providers \(SPs\) to upgrade deployed services and migrate service information. Klaytn will provide this feature carefully by considering the following requirements.

* Only authorized accounts or the owner of a smart contract should be able to upgrade the smart contract.
* Upgraded smart contracts should be able to manipulate existing data maintained by the old smart contract.
* Other smart contracts that refer to the old smart contracts should be able to determine whether to use newer, upgraded versions of those smart contracts.

## Klaytn Tokens and Transaction Fees

### KLAY

KLAY is the main internal transferable cryptocurrency of Klaytn and is used to pay transaction fees when creating or executing smart contracts or when transferring KLAY.

KLAY is a necessary element--a fuel--for operating the Klaytn distributed application platform. It is a form of payment made by the clients of the platform to the consensus nodes \(CNs\) executing the requested operations. To put it another way, KLAY is an incentive; it ensures that developers write high-quality applications \(wasteful code costs more\) and that the network remains healthy \(CNs and RNs are compensated for the resources they contribute\).

#### Units of KLAY

Klaytn uses the following unit system for KLAY.

* `peb` is the smallest currency unit.
* `ston` is an alias for `Gpeb` and introduced for convenience.
* A `KLAY` is 10^18 peb.

| Unit | peb value | peb |
| :--- | :--- | :--- |
| peb | 1 peb | 1 |
| kpeb | 10^3 peb | 1,000 |
| Mpeb | 10^6 peb | 1,000,000 |
| Gpeb | 10^9 peb | 1,000,000,000 |
| ston | 10^9 peb | 1,000,000,000 |
| uKLAY | 10^12 peb | 1,000,000,000,000 |
| mKLAY | 10^15 peb | 1,000,000,000,000,000 |
| KLAY | 10^18 peb | 1,000,000,000,000,000,000 |
| kKLAY | 10^21 peb | 1,000,000,000,000,000,000,000 |
| MKLAY | 10^24 peb | 1,000,000,000,000,000,000,000,000 |
| GKLAY | 10^27 peb | 1,000,000,000,000,000,000,000,000,000 |
| TKLAY | 10^30 peb | 1,000,000,000,000,000,000,000,000,000,000 |

#### APIs Related to KLAY Units

`klay.toPeb` and `klay.fromPeb` are convenient APIs for converting between KLAY units.

```text
$ ./klay attach data/dd/klay.ipc
...
> klay.fromPeb(25, "peb")
"25"
> klay.fromPeb(25, "Gpeb")
"0.000000025"
> klay.fromPeb(25, "ston")
"0.000000025"
> klay.fromPeb(25, "KLAY")
"0.000000000000000025"
> klay.toPeb(25, "peb")
"25"
> klay.toPeb(25, "ston")
"25000000000"
> klay.toPeb(25, "KLAY")
"25000000000000000000"
```

You can get the list of all units supported by `klay.toPeb` and `klay.fromPeb` by sending an invalid unit string such as the one below.

```text
> klay.toPeb(1, "something-does-not-exist")
Error: This unit doesn't exist, please use one of the following units
"noKLAY": "0"
"peb": "1"
"kpeb": "1000"
"Mpeb": "1000000"
"Gpeb": "1000000000"
"ston": "1000000000"
"uKLAY": "1000000000000"
"mKLAY": "1000000000000000"
"KLAY": "1000000000000000000"
"kKLAY": "1000000000000000000000"
"MKLAY": "1000000000000000000000000"
"GKLAY": "1000000000000000000000000000"
"TKLAY": "1000000000000000000000000000000"

    at web3.js:2170:19
    at web3.js:2255:49
    at <anonymous>:1:1
```

### Transaction Fee

Transaction fees can be calculated in various ways depending on the execution environment where the transaction is executed. For example, the transaction fee for the current Klaytn virtual machine \(KLVM\) is computed as follows:

```text
Transaction fee := (total gas used) x (unit price)
```

* The `total gas used` is computed by KLVM based on the gas cost of the opcode and the intrinsic gas cost.

  See [Fee Overview]() for more details.  - `unit price` is the price of gas defined in Klaytn.

This calculated transaction fee is subtracted from the sender's or enterprise account's balance, depending on the transaction.

#### Unit Price

In Klaytn, the unit price is the fixed price of gas defined in the platform and is used to calculate the transaction fee. It is currently set to 25 Gpeb \(_i.e._, 25 x 10^9 peb\) per gas and cannot be changed by user. The current value of the unit price can be obtained by calling the `klay.gasPrice` API.

#### Transaction Validation against Unit Price

Klaytn only accepts transactions with gas prices, which can be set by the user, that are equal to the unit price of Klaytn; it rejects transactions with gas prices that are different from the unit price in Klaytn.

#### Unit Price Error

The error message `invalid unit price` is returned when the gas price of a transaction is not equal to the unit price of Klaytn.

#### Transaction Replacement

Klaytn currently does not provide a way to replace a transaction using the unit price but may support different methods for the transaction replacement in the future. Note that in Ethereum, a transaction with a given nonce can be replaced by a new one with a higher gas price.

