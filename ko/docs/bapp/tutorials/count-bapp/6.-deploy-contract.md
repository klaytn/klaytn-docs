# 6. 스마트 컨트랙트 배포

1\) Truffle 환경 설정  
2\) 배포 설정  
3\) 배포

## 1\) Truffle 환경 설정

`truffle-config.js`는 스마트 컨트랙트 코드를 어떻게 배포할지에 대한 파일입니다. truffle-config.js에서 다음 항목들을 설정할 수 있습니다.

**1\) 스마트 컨트랙트를 배포할 주체\(스마트 컨트랙트를 배포할 Klaytn 계정\)  
2\) 스마트 컨트랙트를 배포할 네트워크  
3\) 스마트 컨트랙트를 배포하는 데에 지불할 가스의 양**

스마트 컨트랙트를 배포하는 데에는 `개인키`를 이용하는 방법과 `잠금 해제된 계정`을 이용하는 방법 두 가지가 있습니다. 

### 배포 방법 1: 개인키

*경고: 개인키를 노출하면 안 됩니다. 만약 노출할 경우 계정이 해킹될 수도 있습니다.*

개인키를 사용하여 스마트 컨트랙트를 배포하려면 `provider` 옵션이 필요합니다.

1\) 개인키를 `new HDWalletProvider()`의 첫 번째 인자로 전달하세요.  
2\) Klaytn 노드의 URL을 `new HDWalletProvider()`의 두 번째 인자로 전달하세요.

예시\)

```javascript
{
 ...,
 provider: new HDWalletProvider(
   'YOUR PRIVATE KEY',
   'https://api.baobab.klaytn.net:8651', // 풀노드를 운용중이라면 운영중인 풀노드의 rpc URL로 설정할 수 있습니다.
  ),
 ...
}
```

```javascript
const HDWalletProvider = require("truffle-hdwallet-provider-klaytn");

const NETWORK_ID = '1001'
const GASLIMIT = '8500000'

/**
 * `URL`, `PRIVATE_KEY`을 상수로 설정하여 쉽게 값을 설정하도록 해줍니다.
 * 여기에 개인키와 Klaytn 노드의 URL을 설정하세요.
 */
const URL = `https://api.baobab.klaytn.net:8651`
const PRIVATE_KEY = '0x48f5a77dbf13b436ae0325ae91efd084430d2da1123a8c273d7df5009248f90c'

module.exports = {
  networks: {
    /**
     * 배포 방법 1: 개인키
     * 개인키를 노출하지 마세요. 노출할 경우 계정이 해킹될 수도 있어요!!
     */
    klaytn: {
      provider: () => new HDWalletProvider(PRIVATE_KEY, URL),
      network_id: NETWORK_ID,
      gas: GASLIMIT,
      gasPrice: null,
    },
  },
}
```

위의 코드에서 `networks` 속성을 봐주세요. 이 속성에는 `klaytn` 키가 있는데, 이 키에는 또 다시 `provider`, `network_id`, `gas`, `gasPrice` 등 4개의 속성이 있습니다.

`provider: new HDWalletProvider(PRIVATE_KEY, URL)` 행은 스마트 컨트랙트를 배포하는 계정과 배포 대상 네트워크의 노드 URL을 받아옵니다.

`network_id: NETWORK_ID` 행은 Klaytn에서의 네트워크 ID를 지정합니다. Baobab 네트워크\(testnet\)는 `1001`입니다.

`gas: GASLIMIT` 행은 스마트 컨트랙트를 배포하는 데에 얼마까지 가스를 지불할 것인지 한도를 지정합니다.

`gasPrice: null` 행은 1 가스당 지불할 금액을 Truffle에 전달합니다. 현재 Klaytn에서는 1 가스당 가격이 `25000000000`으로 고정되어 있습니다. 이 부분을 `null`로 설정하면 Truffle에서 자동적으로 고정 가스 가격으로 설정합니다.

### 베포 방법 2: 잠금 해제된 계정을 이용\(어려운 방법\)

잠금 해제된 계정으로 스마트 컨트랙트를 배포하려면 Klaytn 풀노드가 필요합니다.  
콘솔에 `$ klay attach http://localhost:8551`을 입력하여 Klaytn 풀노드에 접속하세요. 해당 노드에 Klaytn 계정이 없다면 콘솔에 `personal.newAccount()`을 입력하여 계정을 생성하세요.  
계정이 있는 경우 `personal.unlockAccount()`를 입력하여 해당 계정을 잠금 해제하세요.

계정이 잠금 해제된 것을 확인한 후,  
`host`, `port`, `network_id`, `from` 속성을 설정해야 합니다. 1\) `host`, `port`, `network_id`는 배포할 네트워크를 설정하는 속성,  
2\) `from`은 배포할 주체를 설정하는 속성, 3\) `gas`는 배포하는 데에 지불할 가스량의 한도입니다.

잠금 해제한 계정을 `from`에 입력하세요. If you're running your own Klaytn full node, set the node's host to `host` and node's port to `port`.

예시\)

```javascript
{
  host: 'localhost',
  port: 8551,
  from: '0xd0122fc8df283027b6285cc889f5aa624eac1d23',
  network_id: NETWORK_ID,
  gas: GASLIMIT,
  gasPrice: null,
}
```

## 2\) Deploy setup \(Which contract do you want to deploy?\)

`migrations/2_deploy_contracts.js`:

```javascript
const Count = artifacts.require('./Count.sol')
const fs = require('fs')

module.exports = function (deployer) {
  deployer.deploy(Count)
    .then(() => {
    // Record recently deployed contract address to 'deployedAddress' file.
    if (Count._json) {
      // Save abi file to deployedABI.
      fs.writeFile(
        'deployedABI',
        JSON.stringify(Count._json.abi, 2),
        (err) => {
          if (err) throw err
          console.log(`The abi of ${Count._json.contractName} is recorded on deployedABI file`)
        })
    }

    fs.writeFile(
      'deployedAddress',
      Count.address,
      (err) => {
        if (err) throw err
        console.log(`The deployed contract address * ${Count.address} * is recorded on deployedAddress file`)
    })
  })
}
```

You can specify which contract code will you deploy in your `contracts/` directory.  
First, you should import your contract file \(`Count.sol`\) in this file through `const Count = artifacts.require('./Count.sol')`  
And use `deployer` to deploy your contract, through `deployer.deploy(Count)`.  
If you want to run some logic after deploying your contract, use `.then()`.  
We want to store the contract ABI and the deployed address in files. `fs` node.js module is used to do it. \(`fs.writeFile(filename, content, callback)`\)  
Through this post-process, we save our contract address and ABI as `deployedABI` and `deployedAddress` in the directory.  
For further information about `artifacts.`, visit truffle document site, [https://truffleframework.com/docs/truffle/getting-started/running-migrations\#artifacts-require-](https://truffleframework.com/docs/truffle/getting-started/running-migrations#artifacts-require-)

## 3\) Deploy

You need KLAY to deploy a contract. There are 2 different ways to receive testnet KLAY.

* a. On Klaytn wallet <https://baobab.wallet.klaytn.com/faucet> There is a faucet providing 5 KLAY per 86400 blocks in Klaytn Baobab testnet. After creating your Klaytn account, run faucet to receive 5 KLAY.
* b. From the terminal using curl If you already have your Klaytn account\(address\), type the command below in your terminal. `$ curl "https://baobab.wallet.klaytn.com/api/faucet/?address=YOUR_ADDRESS"` example\) `$ curl "https://baobab.wallet.klaytn.com/api/faucet/?address=0x785172fBc2DB6BD6DA59927E79B43EDAa88d58d4"`

![deploy](images/tutorial-3deploy.gif)

Type `$ truffle deploy --network klaytn`.  
It will deploy your contract according to the configurations defined in `truffle-config.js` and `migrations/2_deploy_contracts.js`.

cf\) `--reset` option  
After deploying your contract, if you type `$ truffle deploy --network klaytn` again, nothing will happen.  
Because truffle deploys a contract only when there are changes in the contract, otherwise truffle will not do anything.  
If you want to re-deploy your contract anyway, there is an option `--reset`.  
If you provide this option, truffle will deploy your contract even the content of contract hasn't changed.  
ex\) `$ truffle deploy --reset --network klaytn`

To recap, `truffle-config.js` configures the `target network`, `deployer account`, and the `gas limit`. `migrations/2_deploy_contracts.js` configures the `contract` to deploy.  
`target network`: We deploy our contract to the node `https://api.baobab.klaytn.net:8651` or own full node `http://localhost:8551`.  
`deployer account`: '0xd0122fc8df283027b6285cc889f5aa624eac1d23' will deploy this contract.  
`gas limit`: We can endure up to '20000000' gas for deploying our contract.  
`contract`: We will deploy the Count contract.

From the terminal output, you can see if the deployment has been succeeded and find the deployed address.