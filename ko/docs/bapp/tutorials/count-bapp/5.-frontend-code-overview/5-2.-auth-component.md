# 5-2. Auth 컴포넌트

`src/components/Auth.js`:

## `Auth` 컴포넌트

1\) 배경지식  
2\) `Auth` 컴포넌트 개요  
3\) `Auth` 컴포넌트 기능: 사용자가 개인키를 입력하여 로그인  
4\) `Auth` 컴포넌트 기능: 사용자가 키스토어 파일을 가져온 후 비밀번호를 입력하여 로그인  
5\) `Auth` 컴포넌트 기능: 사용자 로그아웃 후 브라우저에서 지갑 인스턴스 정보를 삭제

### 1\) 배경지식

블록체인 기반의 어플리케이션에서는 일반적으로 스마트 컨트랙트와 상호작용합니다.  
스마트 컨트랙트는 두 가지 상호작용을 합니다.  
`1) 스마트 컨트랙트로부터 데이터를 읽어오기.` `2) 스마트 컨트랙트에 데이터를 쓰기.`

스마트 컨트랙트로부터 데이터를 읽어오는 데에는 비용이 들지 않습니다.  
반면 스마트 컨트랙트에 데이터를 쓰는 데에는 비용이 필요합니다.

참고\) `트랜잭션 보내기`  
스마트 컨트랙트나 블록체인에 데이터를 쓰는 것은 '트랜잭션 보내기'라고 합니다.  
예를 들어 친구에게 5 KLAY를 보낸다는 것은 ` 친구에게 5 KLAY를 보냈다는 데이터를 블록체인에 쓴다`라고 생각할 수 있습니다.  
컨트랙트의 메서드를 호출하는 경우도 이와 동일하죠. 즉 `변수 X를 100으로 설정하겠다는 데이터를 스마트 컨트랙트에 쓴다`라고 볼 수 있습니다. 이처럼 블록체인이나 스마트 컨트랙트에 데이터를 쓰는 것과 관련된 모든 것은 `트랜잭션 보내기`랍니다.

스마트 컨트랙트에 데이터를 쓰려면 트랜잭션 비용을 지불할 수 있는 만큼의 KLAY가 있는 Klaytn 계정이 필요합니다.  
`Auth` 컴포넌트는 어플리케이션에 로그인하도록 해줍니다.

### 2\) `Auth` 컴포넌트 개요

`'Auth.js'` 컴포넌트는 본 튜토리얼의 어플리케이션에서 가장 긴 코드입니다. 그러므로 코드를 세분화하여 하나씩 살펴보도록 할게요.

이 컴포넌트는 다음과 같은 사용자 인터페이스를 제공합니다. ![auth 컴포넌트](../images/tutorial-auth-component.png)

주요 기능은 다음과 같습니다.  
1 \) 사용자는 개인키를 입력하여 로그인할 수 있습니다.   
2 \) 사용자는 키스토어 파일을 가져와 비밀번호를 입력하여 로그인할 수 있습니다.   
3 \) 사용자가 로그아웃한 후 지갑 인스턴스 정보를 브라우저에서 지울 수 있습니다.

### 3\) `Auth` 컴포넌트 기능: 사용자가 개인키를 입력하여 로그인

개인키로 로그인하려면 `integrateWallet` 메서드가 필요합니다.

```javascript
integrateWallet = (privateKey) => {
  const walletInstance = cav.klay.accounts.privateKeyToAccount(privateKey)
  cav.klay.accounts.wallet.add(walletInstance)
  sessionStorage.setItem('walletInstance', JSON.stringify(walletInstance))
  this.reset()
}
```

`integateWallet` 함수는 `privateKey`를 인자로 받아서 지갑 인스턴스를 생성합니다.

Line 1: `const walletInstance = cav.klay.accounts.privateKeyToAccount(privateKey)`  
`privateKeyToAccount` API로 생성한 지갑 인스턴스를 `walletInstance` 변수에 저장합니다.

Line 2: `cav.klay.accounts.wallet.add(walletInstance)`  
트랜잭션을 보내려면 `cav.klay.accounts.wallet.add(walletInstance)`를 통해 지갑 인스턴스를 caver에 추가해야 합니다.

Line 3: `sessionStorage.setItem('walletInstance', JSON.stringify(walletInstance))`  
`sessionStorage.setItem`는 어떤 값을 브라우저 세션 저장소에 저장하는 데에 쓰이는 브라우저 API입니다.  
튜토리얼 어플리케이션의 페이지를 새로 고치더라도 로그인된 상태를 유지해야 하기 때문에 지갑 인스턴스를 JSON 문자열의 형태로 세션 저장소에 저장해놓는 것입니다.

참고\) 브라우저 탭을 닫으면 세션 저장소에 저장된 항목들이 사라집니다.

Line 4: `this.reset()`  
현재 컴포넌트의 상태를 초기화하여 입력을 지웁니다.

For further information about `privateKeyToAccount` API of caver-js, see [caver.klay.accounts.privateKeyToAccount](../../../sdk/caver-js/api-references/caver.klay.accounts.md#privatekeytoaccount)

### 4\) `Auth` 컴포넌트 기능: 사용자가 키스토어 파일을 가져온 후 비밀번호를 입력하여 로그인

키스토어와 비밀번호로 로그인하려면 `handleImport`와 `handleLogin` 메서드가 필요합니다.

```javascript
/**
 * handleImport method takes a file, read
 */
handleImport = (e) => {
  const keystore = e.target.files[0]
  // 'FileReader'는 파일의 내용을 읽어오는 데에 사용됩니다.
  // 'onload' 핸들러와 'readAsText' 메서드를 사용할 것입니다.
  // * FileReader.onload
  // - 이 이벤트는 읽기 작업이 완료될 때마다 발생합니다.
  // * FileReader.readAsText()
  // - 내용을 읽어오기 시작합니다.
  const fileReader = new FileReader()
  fileReader.onload = (e) => {
    try {
      if (!this.checkValidKeystore(e.target.result)) {
        // 키스토어 파일이 유효하지 않으면 "Invalid keystore file." 메세지를 띄웁니다.
        this.setState({ keystoreMsg: 'Invalid keystore file.' })
        return
      }

      // 키스토어 파일이 유효하다면
      // 1) e.target.result를 키스토어로 지정합니다.
      // 2) "It is valid keystore. input your password." 메세지를 띄웁니다.
      this.setState({
        keystore: e.target.result,
        keystoreMsg: 'It is valid keystore. input your password.',
      }, () => document.querySelector('#input-password').focus())
    } catch (e) {
      this.setState({ keystoreMsg: 'Invalid keystore file.' })
      return
    }
  }
  fileReader.readAsText(keystore)
}
```

사용자로부터 파일을 가져오기 위해 `FileReader` 브라우저 API를 사용합니다.  
`e.target.files[0]`은 해당 파일의 메타 정보를 담고 있습니다. 파일의 내용을 읽어오기 위해 `fileReader.readAsText(keystore)` API를 호출합니다.  
`fileReader.readAsText(keystore)`를 호출하면 `fileReader.onload` 함수가 파일의 내용을 `e.target.result`로 가져옵니다.  
이렇게 키스토어 파일을 가져오면 비밀번호 입력을 받습니다.

참고\) 키스토어는 암호화된 개인키를 담고 있습니다. 실제 개인키를 얻으려면 키스토어를 복호화할 수 있는 비밀번호가 필요합니다.  
*경고: 다른 사람에게 키스토어 파일을 노출하지 마세요!*

`<input>` 부분에 비밀번호를 입력하세요. 입력된 값은 `handleChange` 메서드를 통해 `password`에 저장됩니다.

```markup
<input
  id="input-password"
  className="Auth__passwordInput"
  name="password"
  type="password"
  onChange={this.handleChange}
/>
```

키스토어 파일과 비밀번호가 모두 준비되었네요. 이제 `cav.klay.accounts.decrypt(keystore, password)` API를 통해 키스토어 파일을 복호화하여 개인키를 얻을 수 있습니다.  
이때 이 API는 개인키가 포함된 지갑 인스턴스를 반환합니다. 개인키를 가져오면, 앞서 사용한 방법 그대로 `integrateWallet` 메서드를 사용할 수 있습니다.

```javascript
handleLogin = () => {
  const { accessType, keystore, password, privateKey } = this.state

  // 접근 방법 2: 개인키로 접근
  if (accessType == 'privateKey') {
    this.integrateWallet(privateKey)
    return
  }

  // 접근 방법 1: 키스토어 + 비밀번호로 접근
  try {
    const { privateKey: privateKeyFromKeystore } = cav.klay.accounts.decrypt(keystore, password)
    this.integrateWallet(privateKeyFromKeystore)
  } catch (e) {
    this.setState({ keystoreMsg: `Password doesn't match.` })
  }
}
```

For further information about decrypting keystore file with password, see [caver.klay.accounts.decrypt](../../../sdk/caver-js/api-references/caver.klay.accounts.md#decrypt)

### 5\) `Auth` 컴포넌트 기능: 사용자 로그아웃 후 브라우저에서 지갑 인스턴스 정보를 삭제

'로그아웃'은 브라우저와 caver에서 지갑 인스턴스를 제거하는 것을 의미합니다.  
`cav.klay.accounts.wallet.clear()`는 caver의 모든 지갑 인스턴스를 제거합니다.  
`sessionStorage.removeItem('walletInstance')`는 해당 브라우저의 세션 저장소에 있는 지갑 인스턴스를 제거합니다.

```javascript
/**
 * removeWallet 메서드는 다음 항목들을 제거합니다.
 * 1) caver.klay.accounts의 지갑 인스턴스
 * 2) 세션 저장소의 'walletInstance' 값
 */
removeWallet = () => {
  cav.klay.accounts.wallet.clear()
  sessionStorage.removeItem('walletInstance')
  this.reset()
}
```

For further information about clearing a wallet instance from caver-js, see [caver.klay.accounts.wallet.clear](../../../sdk/caver-js/api-references/caver.klay.accounts.md#wallet-clear)