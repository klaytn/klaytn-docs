# 5. 스마트 컨트랙트 배포

1\) 컨트랙트 배포를 위한 테스트넷 KLAY 획득  
2\) Truffle 환경 설정  
3\) 배포 설정\(배포할 컨트랙트 설정\)  
4\) 배포

## 1\) KLAY 획득

컨트랙트를 배포하려면 가스 가격을 지불하기 위해 계정에 KLAY가 필요합니다. 테스트넷의 Klaytn Wallet에서 5 KLAY를 받을 수 있습니다. 1. [Baobab Klaytn Wallet](https://baobab.wallet.klaytn.com/create)에서 Klaytn 계정을 생성하세요 -&gt; Truffle 환경 설정에 `PRIVATE KEY`를 사용할 것입니다. 그러므로 개인키를 어딘가에 따로 복사해놓으세요. 2. Klaytn 계정을 생성했다면 Faucet을 실행하여 [Baobab Klaytn Faucet](https://baobab.wallet.klaytn.com/faucet)에서 5 Baobab 테스트넷 KLAY를 받으세요.

![create-account & run-klay-faucet](images/klaystagram-run-faucet.png)

## 2\) Truffle 환경 설정

`truffle-config.js` is a configuration file including deployment configuration. We are going to deploy our contract using `Private key` we've just created in the previous step. Paste your `Private key` that has enough KLAY to truffle-config.js

*경고: 개인키를 노출하면 안 됩니다. 만약 노출할 경우 계정이 해킹될 수도 있습니다.*

```javascript
// truffle-config.js

const HDWalletProvider = require("truffle-hdwallet-provider-klaytn");

/**
 * truffle network variables
 * for deploying contract to klaytn network.
 */
const NETWORK_ID = '1001'

/**
 * URL: URL for the remote node you will be using
 * PRIVATE_KEY: Private key of the account that pays for the transaction (Change it to your own private key)
 */
const URL = 'https://api.baobab.klaytn.net:8651'

// Paste your `Private key` that has enough KLAY to truffle.js
const PRIVATE_KEY = '0x3de0c90ce7e440f19eff6439390c29389f611725422b79c95f9f48c856b58277'

module.exports = {
  networks: {
    klaytn: {
      provider: () => new HDWalletProvider(PRIVATE_KEY, URL),
      network_id: NETWORK_ID,
      gas: '8500000',
      gasPrice: null,
    },
  },

  // Specify the version of compiler, we use 0.4.24
  compilers: {
    solc: {
      version: '0.4.24',
    },
  },
}
```

### `networks` property

See `networks` property above. `klaytn` network has 4 properties,  
`provider`, `network_id`, `gas`, `gasPrice`.

* `provider: () => new HDWalletProvider(PRIVATE_KEY, URL)` Just as the name indicates, it injects private key and url defined above.
* `network_id: NETWORK_ID` Specify network id in Klaytn, you should set it to `1001` to use Klaytn Baobab network \(testnet\).
* `gas: GASLIMIT` Maximum gas you are willing to spend.
* `gasPrice: null` This is price per every gas unit. Currently in Klaytn, the gas price is fixed to `'25000000000'`. By setting it to `null`, truffle will automatically set the gas price.

### `compiler` property

Remember that for Solidity contract we used version 0.4.24, thus specify compiler version here.

## 3\) 배포 설정

`migrations/2_deploy_contracts.js`:

```javascript
const Klaystagram = artifacts.require('./Klaystagram.sol')
const fs = require('fs')

module.exports = function (deployer) {
  deployer.deploy(Klaystagram)
    .then(() => {
    if (Klaystagram._json) {
      // 1. Record recently deployed contract's abi file to 'deployedABI'
      fs.writeFile(
        'deployedABI',
        JSON.stringify(Klaystagram._json.abi, 2),
        (err) => {
          if (err) throw err
          console.log(`The abi of ${Klaystagram._json.contractName} is recorded on deployedABI file`)
        })
    }

    // 2. Record recently deployed contract's address to 'deployedAddress'
    fs.writeFile(
      'deployedAddress',
      Klaystagram.address,
      (err) => {
        if (err) throw err
        console.log(`The deployed contract address * ${Klaystagram.address} * is recorded on deployedAddress file`)
    })
  })
}
```

You can specify which contract code will you deploy in your `contracts/` directory.

1. Import your contract file \(`Klaystagram.sol`\) via
    
    `const Klaystagram = artifacts.require('./Klaystagram.sol')`

2. Use `deployer` to deploy your contract, `deployer.deploy(Klaystagram)`.

3. If you want to add more logic after deploying your contract, use `.then()` \(optional\) 
4. To save contracts' `deployedABI` and `deployedAddress`, use `fs` node.js module
    
    `fs.writeFile(filename, content, callback)` \(optional\)

cf. For further information about `artifacts.require()`, refer to truffle official documentation at [truffle docs](https://truffleframework.com/docs/truffle/getting-started/running-migrations#artifacts-require-.)

## 4\) 배포

![deploy contract](images/klaystagram-deploy-contract.png)

In your terminal type `$ truffle deploy --network klaytn`.  
It will deploy your contract according to `truffle-config.js` and `migrations/2_deploy_contracts.js` configuration.

Terminal will display deployed contract address if deployment was successful.

cf\) `--reset` option  
If you provide this option, truffle will recompile and redeploy your contract even if contracts haven't changed.  
ex\) `$ truffle deploy --reset --network klaytn`