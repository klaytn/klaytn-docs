# 5-2. Thành phần xác thực

`src/components/Auth.js`:

## Thành phần `Auth` <a href="#auth-component" id="auth-component"></a>

1\) Hình nền\
2\) Tổng quan thành phần `Auth`\
3\) Tính năng thành phần `Auth`: Người dùng có thể nhập khóa riêng tư để đăng nhập.\
4\) Tính năng thành phần `Auth`: Người dùng có thể nhập file lưu trữ khóa và nhập mật khẩu để đăng nhập.\
5\) Tính năng thành phần `Auth`: Người dùng có thể đăng xuất và xóa thông tin phiên bản ví khỏi trình duyệt.

### 1) Hình nền <a href="#1-background" id="1-background"></a>

Trong ứng dụng trên nền tảng blockchain, chúng tôi thường tương tác với hợp đồng thông minh.\
Có 2 loại tương tác với hợp đồng.\ `1) Đọc dữ liệu từ hợp đồng.` `2) Ghi dữ liệu vào hợp đồng.`

Không tốn chi phí để đọc dữ liệu từ hợp đồng.\
Tuy nhiên, có chi phí cho việc ghi dữ liệu vào hợp đồng.

cf) `Gửi giao dịch`\
Ghi dữ liệu vào hợp đồng hoặc blockchain được gọi là 'gửi giao dịch'.\ Ví dụ, nếu bạn gửi 5 KLAY cho bạn của mình, bạn có thể nghĩ là `ghi dữ liệu vào blockchain là tôi đã gửi 5 KLAY cho bạn của mình`.\
Tương tự với cách gọi phương thức hợp đồng. Bạn có thể nghĩ nó là `ghi dữ liệu vào hợp đồng là tôi đặt giá trị của biến X bằng 100`. Tất cả các hành động liên quan đến việc ghi dữ liệu vào blockchain hoặc hợp đồng đều được gọi là `gửi giao dịch`.

Để ghi dữ liệu vào hợp đồng, bạn nên có một tài khoản Klaytn có số dư KLAY để thanh toán phí giao dịch.\
thành phần `Auth` sẽ giúp bạn đăng nhập vào ứng dụng.

### 2) Tổng quan thành phần`Auth` <a href="#2-auth-component-overview" id="2-auth-component-overview"></a>

Thành phần `'Auth.js'` là mã lệnh dài nhất trong ứng dụng hướng dẫn của chúng tôi, vì thế chúng tôi sẽ chia nhỏ đoạn mã lệnh ra và thực hiện từng bước một.

Thành phần này cung cấp giao diện người dùng sau đây. ![auth-component](../../../../bapp/tutorials/count-bapp/images/tutorial-auth-component.png)

Tính năng chính là:\
1\) Người dùng có thể nhập khóa riêng tư để đăng nhập.\ 2\) Người dùng có thể nhập file lưu trữ khóa và nhập mật khẩu để đăng nhập.\
3\) Người dùng có thể đăng xuất và xóa thông tin phiên bản của ví từ trình duyệt.

### 3) Tính năng thành phần `Auth`: Người dùng có thể nhập khóa riêng tư để đăng nhập. <a href="#3-auth-component-feature-user-can-input-private-key-to-login" id="3-auth-component-feature-user-can-input-private-key-to-login"></a>

Cần có phương thức `integrateWallet` để đăng nhập bằng khóa riêng tư.

```javascript
integrateWallet = (privateKey) => {
  const walletInstance = cav.klay.accounts.privateKeyToAccount(privateKey)
  cav.klay.accounts.wallet.add(walletInstance)
  sessionStorage.setItem('walletInstance', JSON.stringify(walletInstance))
  this.reset()
}
```

Hàm `integateWallet` lấy `privateKey` làm tham số để tạo ra một phiên bản ví.

Dòng 1: `const walletInstance = cav.klay.accounts.privateKeyToAccount(privateKey)`\
Nó lưu phiên bản ví do API `privateKeyToAccount` tạo ra vào biến `walletInstance`.

Dòng 2: `cav.klay.accounts.wallet.add(walletInstance)`\
Để gửi giao dịch, bạn nên thêm phiên bản ví vào caver bằng hàm `cav.klay.accounts.wallet.add(walletInstance)`.

Dòng 3: `sessionStorage.setItem('walletInstance', JSON.stringify(walletInstance))`\
`sessionStorage.setItem` là API trình duyệt dùng để lưu trữ giá trị vào nơi lưu trữ phiên của trình duyệt.\
Vì không muốn mất trạng thái đăng nhập cả khi làm mới trang ứng dụng hướng dẫn của mình, chúng tôi đã lưu phiên bản của ví vào nơi lưu trữ phiên bằng chuỗi JSON.

cf) Các mục trong phần lưu trữ phiên sẽ mất khi người dùng đóng tab trình duyệt.

Dòng 4: `this.reset()`\
Nó đặt lại trạng thái của thành phần hiện tại về trạng thái khởi tạo ban đầu để xóa dữ liệu bạn nhập.

Để biết thêm thông tin về API `privateKeyToAccount` của caver-js, hãy xem [caver.klay.accounts.privateKeyToAccount](../../../sdk/caver-js/v1.4.1/api-references/caver.klay.accounts.md#privatekeytoaccount)

### 4) Tính năng thành phần `Auth`: Người dùng có thể nhập file lưu trữ khóa và nhập mật khẩu để đăng nhập. <a href="#4-auth-component-feature-user-can-import-keystore-file-and-input-password-to-log" id="4-auth-component-feature-user-can-import-keystore-file-and-input-password-to-log"></a>

Cần phương thức `handleImport` và `handleLogin` để đăng nhập bằng lưu trữ khóa và mật khẩu.

```javascript
/**
 * phương thức handleImport mở file, đọc
 */
handleImport = (e) => {
  const keystore = e.target.files[0]
  // 'FileReader' được dùng để đọc nội dung file.
  // Chúng tôi sử dụng handler 'onload' và phương thức 'readAsText'.
  // * FileReader.onload
  // - Sự kiện này được kích hoạt mỗi khi hoàn tất hoạt động đọc.
  // * FileReader.readAsText()
  // - Bắt đầu đọc nội dung.
  const fileReader = new FileReader()
  fileReader.onload = (e) => {
    try {
      if (!this.checkValidKeystore(e.target.result)) {
        // Nếu file lưu trữ khóa không hợp lệ, hiển thị thông báo "File lưu trữ khóa không hợp lệ."
        this.setState({ keystoreMsg: 'File lưu trữ khóa không hợp lệ.' })
        return
      }

      // Nếu file lưu trữ khóa hợp lệ,
      // 1) đặt biến lưu trữ khóa e.target.result
      // 2) hiển thị thông báo "Lưu trữ khóa hợp lệ. nhập mật khẩu."
      this.setState({
        keystore: e.target.result,
        keystoreMsg: 'Lưu trữ khóa hợp lệ. nhập mật khẩu.',
      }, () => document.querySelector('#input-password').focus())
    } catch (e) {
      this.setState({ keystoreMsg: 'File lưu trữ khóa không hợp lệ.' })
      return
    }
  }
  fileReader.readAsText(keystore)
}
```

Để nhập file từ người dùng, chúng tôi sử dụng API trình duyệt `FileReader`.\
`e.target.files[0]` chứa thông tin meta cho file. Để đọc nội dung của file, chúng tôi gọi API `fileReader.readAsText(keystore)`.\
Sau khi gọi hàm `fileReader.readAsText(keystore)`, hàm `fileReader.onload` sẽ chạy để lấy nội dung của file vào `e.target.result`.\
Sau khi nhập file lưu trữ khóa, chúng tôi nhập mật khẩu.

cf) Keystore contains an encrypted private key. We need the matching password to decrypt the keystore to get the actual private key.\
_WARNING Don't expose your keystore file to another person!_

Fill password into `<input>` element. Entered value will be stored as `password` state through `handleChange` method.

```markup
<input
  id="input-password"
  className="Auth__passwordInput"
  name="password"
  type="password"
  onChange={this.handleChange}
/>
```

Both the keystore file and its password are ready. We can now decrypt the keystore file to extract the private key through `cav.klay.accounts.decrypt(keystore, password)` API.\
This API returns a wallet instance containing the private key. After importing the private key, we can use `integrateWallet` method we've visited earlier.

```javascript
handleLogin = () => {
  const { accessType, keystore, password, privateKey } = this.state

  // Access type2: access through private key
  if (accessType == 'privateKey') {
    this.integrateWallet(privateKey)
    return
  }

  // Access type1: access through keystore + password
  try {
    const { privateKey: privateKeyFromKeystore } = cav.klay.accounts.decrypt(keystore, password)
    this.integrateWallet(privateKeyFromKeystore)
  } catch (e) {
    this.setState({ keystoreMsg: `Password doesn't match.` })
  }
}
```

For further information about decrypting keystore file with password, see [caver.klay.accounts.decrypt](../../../sdk/caver-js/v1.4.1/api-references/caver.klay.accounts.md#decrypt)

### 5) `Auth` component feature: User can logout, remove wallet instance information from browser. <a href="#5-auth-component-feature-user-can-logout-remove-wallet-instance-information-from" id="5-auth-component-feature-user-can-logout-remove-wallet-instance-information-from"></a>

'logout' means removing the wallet instance from the browser and caver.\
`cav.klay.accounts.wallet.clear()` removes all wallet instances from caver.\
`sessionStorage.removeItem('walletInstance')` removes the wallet instance from the browser's session storage.

```javascript
/**
 * removeWallet method removes
 * 1) wallet instance from caver.klay.accounts
 * 2) 'walletInstance' value from session storage.
 */
removeWallet = () => {
  cav.klay.accounts.wallet.clear()
  sessionStorage.removeItem('walletInstance')
  this.reset()
}
```

For further information about clearing a wallet instance from caver-js, see [caver.klay.accounts.wallet.clear](../../../sdk/caver-js/v1.4.1/api-references/caver.klay.accounts.md#wallet-clear)
